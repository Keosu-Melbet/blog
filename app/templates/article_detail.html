{% extends "base.html" %}

{% block title %}{{ article.meta_title or article.title }}{% endblock %}
{% block description %}{{ article.meta_description or article.get_excerpt() }}{% endblock %}
{% block keywords %}{{ article.meta_keywords or 'kèo bóng đá, soi kèo, ' + article.category.name }}{% endblock %}

{% block extra_css %}
<style>
.article-header {
    background: linear-gradient(135deg, var(--primary-black) 0%, var(--dark-gray) 100%);
    color: white;
    padding: 60px 0;
    position: relative;
    overflow: hidden;
}

.article-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="%23ffd700" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
}

.article-content-wrapper {
    position: relative;
    z-index: 2;
}

.article-meta {
    margin-bottom: 20px;
}

.article-meta-item {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-right: 25px;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
}

.article-title {
    font-size: 3rem;
    font-weight: 900;
    margin-bottom: 20px;
    line-height: 1.2;
}

.article-excerpt {
    font-size: 1.3rem;
    opacity: 0.9;
    line-height: 1.6;
}

.breadcrumb-nav {
    background: var(--light-gray);
    padding: 15px 0;
}

.breadcrumb {
    background: none;
    padding: 0;
    margin: 0;
}

.breadcrumb-item a {
    color: var(--primary-black);
    text-decoration: none;
}

.breadcrumb-item a:hover {
    color: var(--primary-yellow);
}

.breadcrumb-item.active {
    color: var(--text-gray);
}

.article-content {
    background: white;
    border-radius: 20px;
    padding: 40px;
    margin: -50px 0 40px;
    position: relative;
    z-index: 3;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

.article-featured-image {
    width: 100%;
    max-height: 400px;
    object-fit: cover;
    border-radius: 15px;
    margin-bottom: 30px;
}

.article-body {
    font-size: 1.1rem;
    line-height: 1.8;
    color: var(--primary-black);
}

.article-body h1,
.article-body h2,
.article-body h3,
.article-body h4,
.article-body h5,
.article-body h6 {
    color: var(--primary-black);
    font-weight: 700;
    margin: 30px 0 15px;
}

.article-body h1 {
    font-size: 2.2rem;
    border-bottom: 3px solid var(--primary-yellow);
    padding-bottom: 10px;
}

.article-body h2 {
    font-size: 1.8rem;
    border-left: 5px solid var(--primary-yellow);
    padding-left: 15px;
}

.article-body h3 {
    font-size: 1.5rem;
}

.article-body p {
    margin-bottom: 20px;
}

.article-body blockquote {
    background: var(--light-gray);
    border-left: 5px solid var(--primary-yellow);
    padding: 20px;
    margin: 25px 0;
    font-style: italic;
    border-radius: 0 10px 10px 0;
}

.article-body ul,
.article-body ol {
    margin: 20px 0;
    padding-left: 30px;
}

.article-body li {
    margin-bottom: 8px;
}

.article-body a {
    color: var(--primary-yellow);
    text-decoration: none;
    font-weight: 600;
}

.article-body a:hover {
    text-decoration: underline;
}

.article-footer {
    background: var(--light-gray);
    padding: 30px;
    border-radius: 15px;
    margin-top: 40px;
}

.article-tags {
    margin-bottom: 20px;
}

.tag {
    background: var(--primary-yellow);
    color: var(--primary-black);
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    margin: 5px 10px 5px 0;
    transition: all 0.3s ease;
}

.tag:hover {
    background: var(--primary-black);
    color: var(--primary-yellow);
    transform: translateY(-2px);
}

.share-buttons {
    display: flex;
    gap: 15px;
    align-items: center;
}

.share-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 1.2rem;
}

.share-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.share-btn.facebook { background: #1877f2; }
.share-btn.twitter { background: #1da1f2; }
.share-btn.linkedin { background: #0077b5; }
.share-btn.telegram { background: #0088cc; }

.related-articles {
    margin-top: 60px;
}

.related-article-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    height: 100%;
}

.related-article-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.15);
}

.related-article-card img {
    height: 180px;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.related-article-card:hover img {
    transform: scale(1.05);
}

.author-bio {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    border-left: 5px solid var(--primary-yellow);
}

.author-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--primary-yellow);
    color: var(--primary-black);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: bold;
}

.toc {
    background: var(--light-gray);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
    position: sticky;
    top: 100px;
}

.toc h5 {
    color: var(--primary-black);
    margin-bottom: 15px;
    font-weight: 700;
}

.toc ul {
    list-style: none;
    padding: 0;
}

.toc li {
    margin-bottom: 8px;
}

.toc a {
    color: var(--text-gray);
    text-decoration: none;
    display: block;
    padding: 5px 0;
    transition: color 0.3s ease;
}

.toc a:hover {
    color: var(--primary-yellow);
}

@media (max-width: 768px) {
    .article-title {
        font-size: 2rem;
    }
    
    .article-excerpt {
        font-size: 1.1rem;
    }
    
    .article-content {
        margin: -30px 15px 30px;
        padding: 25px;
    }
    
    .article-meta-item {
        display: block;
        margin-bottom: 10px;
    }
    
    .share-buttons {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .toc {
        position: static;
        margin-bottom: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="breadcrumb-nav">
    <div class="container">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('index') }}">
                    <i class="fas fa-home"></i>
                    Trang chủ
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('category_articles', slug=article.category.slug) }}">
                    {{ article.category.name }}
                </a>
            </li>
            <li class="breadcrumb-item active">{{ article.title[:50] }}...</li>
        </ol>
    </div>
</nav>

<!-- Article Header -->
<header class="article-header">
    <div class="container">
        <div class="article-content-wrapper">
            <div class="row">
                <div class="col-lg-8 mx-auto text-center">
                    <div class="article-meta">
                        <span class="article-meta-item">
                            <i class="fas fa-folder"></i>
                            {{ article.category.name }}
                        </span>
                        <span class="article-meta-item">
                            <i class="fas fa-calendar"></i>
                            {{ article.created_at.strftime('%d/%m/%Y') }}
                        </span>
                        <span class="article-meta-item">
                            <i class="fas fa-user"></i>
                            {{ article.author }}
                        </span>
                        <span class="article-meta-item">
                            <i class="fas fa-eye"></i>
                            {{ article.views }} lượt xem
                        </span>
                    </div>
                    
                    <h1 class="article-title">{{ article.title }}</h1>
                    
                    {% if article.excerpt %}
                    <p class="article-excerpt">{{ article.excerpt }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="container">
    <div class="row">
        <div class="col-lg-8">
            <article class="article-content">
                {% if article.featured_image %}
                <img src="{{ url_for('static', filename=article.featured_image) }}" 
                     class="article-featured-image" 
                     alt="{{ article.title }}">
                {% endif %}
                
                <div class="article-body">
                    {{ article.content|safe }}
                </div>
                
                <div class="article-footer">
                    {% if article.meta_keywords %}
                    <div class="article-tags">
                        <h6>
                            <i class="fas fa-tags"></i>
                            Thẻ liên quan:
                        </h6>
                        {% for keyword in article.meta_keywords.split(',') %}
                        <a href="{{ url_for('search') }}?query={{ keyword.strip() }}" class="tag">
                            {{ keyword.strip() }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <h6>
                            <i class="fas fa-share-alt"></i>
                            Chia sẻ bài viết:
                        </h6>
                        <div class="share-buttons">
                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" 
                               target="_blank" class="share-btn facebook" title="Chia sẻ lên Facebook">
                                <i class="fab fa-facebook-f"></i>
                            </a>
                            <a href="https://twitter.com/intent/tweet?url={{ request.url }}&text={{ article.title }}" 
                               target="_blank" class="share-btn twitter" title="Chia sẻ lên Twitter">
                                <i class="fab fa-twitter"></i>
                            </a>
                            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.url }}" 
                               target="_blank" class="share-btn linkedin" title="Chia sẻ lên LinkedIn">
                                <i class="fab fa-linkedin-in"></i>
                            </a>
                            <a href="https://t.me/share/url?url={{ request.url }}&text={{ article.title }}" 
                               target="_blank" class="share-btn telegram" title="Chia sẻ qua Telegram">
                                <i class="fab fa-telegram-plane"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </article>
        </div>
        
        <div class="col-lg-4">
            <!-- Table of Contents -->
            <div class="toc">
                <h5>
                    <i class="fas fa-list"></i>
                    Mục lục
                </h5>
                <ul id="tableOfContents">
                    <!-- Generated by JavaScript -->
                </ul>
            </div>
            
            <!-- Author Bio -->
            <div class="author-bio">
                <div class="d-flex align-items-center mb-3">
                    <div class="author-avatar me-3">
                        {{ article.author[0].upper() }}
                    </div>
                    <div>
                        <h6 class="mb-1">{{ article.author }}</h6>
                        <small class="text-muted">Chuyên gia phân tích</small>
                    </div>
                </div>
                <p class="mb-0">
                    Chuyên gia hàng đầu tại Kèo Sư với nhiều năm kinh nghiệm trong lĩnh vực phân tích 
                    và dự đoán kèo bóng đá. Cam kết mang đến những thông tin chính xác và hữu ích nhất.
                </p>
            </div>
        </div>
    </div>
</main>

<!-- Related Articles -->
{% if related_articles %}
<section class="related-articles py-5 bg-light">
    <div class="container">
        <h2 class="section-title">
            <i class="fas fa-newspaper"></i>
            Bài viết liên quan
        </h2>
        
        <div class="row">
            {% for related in related_articles %}
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="related-article-card">
                    {% if related.featured_image %}
                    <img src="{{ url_for('static', filename=related.featured_image) }}" 
                         class="card-img-top" 
                         alt="{{ related.title }}">
                    {% else %}
                    <div class="card-img-top bg-warning d-flex align-items-center justify-content-center" style="height: 180px;">
                        <i class="fas fa-{{ 'fire' if related.category.slug == 'keo-thom' else 'search' if related.category.slug == 'soi-keo' else 'lightbulb' if related.category.slug == 'meo-cuoc' else 'newspaper' }} fa-3x text-dark"></i>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <span class="badge-category">{{ related.category.name }}</span>
                        <h6 class="card-title">
                            <a href="{{ url_for('article_detail', slug=related.slug) }}">
                                {{ related.title }}
                            </a>
                        </h6>
                        <p class="card-text">{{ related.get_excerpt(80) }}</p>
                        <div class="card-meta">
                            <small>
                                <i class="fas fa-calendar"></i>
                                {{ related.created_at.strftime('%d/%m/%Y') }}
                            </small>
                            <small>
                                <i class="fas fa-eye"></i>
                                {{ related.views }} lượt xem
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Chatbot Integration -->
<section class="chatbot-cta py-5 bg-dark text-white">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h3>
                    <i class="fas fa-robot"></i>
                    Có câu hỏi về bài viết này?
                </h3>
                <p>Chat với Kèo Sư AI để được giải đáp thêm về nội dung bài viết và nhận tư vấn chuyên nghiệp</p>
            </div>
            <div class="col-lg-4 text-end">
                <button class="btn btn-warning btn-lg" onclick="document.querySelector('.chatbot-toggle').click()">
                    <i class="fas fa-comments"></i>
                    Hỏi Kèo Sư AI
                </button>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block structured_data %}
{{ super() }}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "{{ article.title }}",
    "description": "{{ article.get_excerpt() }}",
    "image": "{% if article.featured_image %}{{ request.host_url }}{{ url_for('static', filename=article.featured_image) }}{% endif %}",
    "author": {
        "@type": "Person",
        "name": "{{ article.author }}"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Kèo Sư",
        "logo": {
            "@type": "ImageObject",
            "url": "{{ request.host_url }}{{ url_for('static', filename='images/logo.png') }}"
        }
    },
    "datePublished": "{{ article.created_at.isoformat() }}",
    "dateModified": "{{ article.updated_at.isoformat() }}",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "{{ request.url }}"
    }
}
</script>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Generate table of contents
    generateTableOfContents();
    
    // Smooth scrolling for TOC links
    document.querySelectorAll('#tableOfContents a').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
    
    // Highlight current section in TOC
    window.addEventListener('scroll', highlightCurrentSection);
});

function generateTableOfContents() {
    const headings = document.querySelectorAll('.article-body h1, .article-body h2, .article-body h3');
    const toc = document.getElementById('tableOfContents');
    
    if (headings.length === 0) {
        toc.innerHTML = '<li><em>Không có mục lục</em></li>';
        return;
    }
    
    headings.forEach((heading, index) => {
        // Create ID if not exists
        if (!heading.id) {
            heading.id = `heading-${index}`;
        }
        
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `#${heading.id}`;
        a.textContent = heading.textContent;
        a.style.paddingLeft = `${(parseInt(heading.tagName.substring(1)) - 1) * 15}px`;
        
        li.appendChild(a);
        toc.appendChild(li);
    });
}

function highlightCurrentSection() {
    const headings = document.querySelectorAll('.article-body h1, .article-body h2, .article-body h3');
    const tocLinks = document.querySelectorAll('#tableOfContents a');
    
    let currentHeading = null;
    
    headings.forEach(heading => {
        const rect = heading.getBoundingClientRect();
        if (rect.top <= 100) {
            currentHeading = heading;
        }
    });
    
    tocLinks.forEach(link => {
        link.style.color = '';
        link.style.fontWeight = '';
    });
    
    if (currentHeading) {
        const activeLink = document.querySelector(`#tableOfContents a[href="#${currentHeading.id}"]`);
        if (activeLink) {
            activeLink.style.color = '#ffd700';
            activeLink.style.fontWeight = 'bold';
        }
    }
}

// Reading progress indicator
function updateReadingProgress() {
    const article = document.querySelector('.article-body');
    const scrollTop = window.pageYOffset;
    const scrollHeight = article.offsetHeight;
    const clientHeight = window.innerHeight;
    
    const progress = (scrollTop / (scrollHeight - clientHeight)) * 100;
    
    // You can use this progress value to update a progress bar
    console.log(`Reading progress: ${Math.min(100, Math.max(0, progress))}%`);
}

window.addEventListener('scroll', updateReadingProgress);

// Social sharing tracking
document.querySelectorAll('.share-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const platform = this.classList.contains('facebook') ? 'Facebook' :
                        this.classList.contains('twitter') ? 'Twitter' :
                        this.classList.contains('linkedin') ? 'LinkedIn' : 'Telegram';
        
        // Track sharing event (you can send this to analytics)
        console.log(`Article shared on ${platform}: {{ article.title }}`);
    });
});
</script>
{% endblock %}
